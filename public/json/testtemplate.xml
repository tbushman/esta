<?xml version="1.0" encoding="utf-8" ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge; charset=utf-8"/><title></title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="stylesheet" href="/stylesheets/simplemde.min.css"/><link rel="stylesheet" href="/stylesheets/style.css"/><style id="style" type="text/css"></style><script type="text/javascript" src="/scripts/vue.min.js"></script><script type="text/javascript" src="/scripts/jquery.min.js"></script><script type="text/javascript" src="/scripts/jquery-ui.min.js"></script><script type="text/javascript" src="/scripts/moment-with-locales.min.js"></script><script type="text/javascript" src="/scripts/marked.min.js"></script><script type="text/javascript" src="/scripts/simplemde.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mocha/3.0.2/mocha.min.js"></script></head><body><div class="centerallwrap" id="vue"><!--doctype xml--><maintitle class="centerall" style="display: block"><chapter><section class="row" v-for="doc in data"><form class="tb-10-m0 form" v-bind:id="'form_'+dindex" enctype="multipart/form-data" method="POST" action="/api/editcontent/5b5247a03ae467d9b385ea10" name="editform"><input type="hidden" name="_csrf"/><div class="row tb-font-l">Title <span><titlenum class="bd" v-text="doc.title.ind + 1"></titlenum></span><span v-text="' '"> <titlename class="bd" v-text="doc.title.str"></titlename></span></div><div class="row tb-font-l">Chapter <span><chapternum class="bd" v-text="doc.chapter.ind + 1"></chapternum></span><span v-text="' '"><chaptername class="bd" v-text="doc.chapter.str"></chaptername></span></div><sectionnum class="bd" v-text="(doc.title.ind + 1)+'.'+(doc.chapter.ind + 1)+'.'+(doc.section.ind + 1)"></sectionnum><span v-text="' '"></span><sectionname v-text="doc.section.str"></sectionname><label class="tb-10-m0" v-if="edit === dindexes.indexOf(doc.index)" for="place">Place</label><input v-if="edit === dindexes.indexOf(doc.index)" v-bind:value="doc.properties.place" type="text" name="place"/><place class="tb-10-m0 tb-font-s" v-if="!edit" v-text="doc.properties.place"></place><label class="tb-10-m0" v-if="edit === dindexes.indexOf(doc.index)" v-on:click="toggleEdit(dindexes.indexOf(doc.index))" for="description">Description</label><textarea id="layouttext" v-if="edit === dindexes.indexOf(doc.index)" v-text="doc.properties.description" name="description"></textarea><description class="tb-10-m0" id="testbtn" v-if="!edit" v-on:click="toggleEdit(dindexes.indexOf(doc.index))" v-html="marked(doc.properties.description)"></description><rss version="1.0" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom"><channel class="tb-font-xxs"><title v-if="!edit" v-bind:style="{display:'inline-block'}" v-text="doc.title.str"></title><link v-if="!edit" v-bind:href="'http://undefined'" rel="self"/><description v-if="!edit" v-text="doc.chapter.str"></description><ttl v-text="60"></ttl><item class="row" v-for="img in doc.properties.media"><div class="tb-10-m0 tb-font-m" v-if="edit === dindexes.indexOf(doc.index)"><input type="hidden" v-bind:id="'inputthumb'+img.index" v-bind:name="'thumb'+img.index" v-bind:value="img.thumb"/><input type="hidden" v-bind:id="'inputimg'+img.index" v-bind:name="'img'+img.index" v-bind:value="img.image"/><canvas v-bind:id="'canvas'+img.index" style="display: none;"></canvas><input class="featuredimg" type="hidden" v-bind:id="'featured'+img.index" v-bind:name="'img'+img.index+'_featured'" v-bind:value="img.featured"/><div class="row"><div class="tb-04-m0 tb-02-m3"><p class="img sm" href="#" v-bind:id="img.index" v-bind:name="doc._id"><img class="block" v-bind:id="'return'+img.index" v-bind:src="img.thumb+'?ver=0.0'"/></p><div class="row"><div class="tb-08-m0" style="padding-top: 8px;"><label>Featured Image?</label></div><div class="tb-02-m0"><input style="height: 100%; padding: 2px 8px;" type="button" v-bind:id="'togglefeatured_'+img.index" v-bind:class="(img.featured?'featured toggle':'toggle')"/></div></div><p></p><label for="media">Change media</label><input v-bind:id="'media_'+img.index" v-on:change="handleFile(dindexes.indexOf(doc.index),img.index)" v-bind:class="'editmedia@'+img.index" type="file"/><label v-bind:for="'deletemedia_'+img.index"></label><a class="block spacer deletemedia" role="button" v-bind:id="'deletemedia_'+img.index"><span style="color: #777;">Delete Media</span></a></div><div class="tb-06-m0 tb-08-m3 shift-00"><label v-bind:for="'img'+img.index+'_name'">Image Title</label><input type="text" v-bind:name="'img'+img.index+'_name'" v-bind:id="'img'+img.index+'_name'" v-bind:value="img.name"/><label v-bind:for="'img'+img.index+'_caption'">Image Caption</label><textarea type="text" v-bind:name="'img'+img.index+'_caption'" v-bind:id="'img'+img.index+'_caption'" v-text="img.caption"></textarea><label v-bind:for="'img'+img.index+'_postscript'">Caption postscript</label><input type="text" v-bind:name="'img'+img.index+'_postscript'" v-bind:id="'img'+img.index+'_postscript'" value="img.postscript"/><label v-bind:for="'iframe'+img.index">Video URL</label><input type="text" v-bind:name="'iframe'+img.index" v-bind:id="'iframe'+img.index" v-bind:value="img.iframe"/></div></div></div><img class="tb-10-m0" v-bind:href="img.image_abs" style="height:100px" v-bind:src="img.image"/><!--image
	title(v-if="!edit", v-bind:style="{display:'inline-block'}", v-text="doc.title.str")
	link(v-if="!edit", v-bind:href="'http://"+appURL+"'", rel="self")
	url(v-text="'file://'+img.image")
	width(v-text="100")
	height(v-text="100")
	description(v-text="img.caption")
--></item></channel></rss><coord class="tb-font-xxs bd" v-text="doc.geometry.coordinates.toString()"></coord><hr/><a class="block" v-if="edit === dindexes.indexOf(doc.index)" role="button" v-bind:id="'submit_'+dindex" v-on:click="submitForm(dindexes.indexOf(doc.index))"><span>Finished editing</span></a></form></section></chapter></maintitle></div><script type="text/javascript">new Vue({
	el: '#vue',
	data: function data(){
		return {
			menu: this.parseObj("view"),
			data: this.parseObj([{"title":{"ind":24,"str":"Subdivisions"},"chapter":{"ind":0,"str":"General Provisions"},"section":{"ind":0,"str":"Short Title"},"properties":{"published":false,"title":"","label":"","place":"Edit Place","description":"...edit description... OKsimple programmer","media":[{"_id":"5b5577c78d0791e8b28767d6","index":0,"name":"Sample image","image":"/publishers/ordinancer/images/full/0/img_0.png","thumb":"/publishers/ordinancer/images/thumbs/0/thumb_0.png","caption":"Sample caption","postscript":"img.postscript"}]},"geometry":{"coordinates":[-111.854704,40.769673],"type":"Point"},"_id":"5b5247a03ae467d9b385ea10","type":"Feature","index":0,"__v":0}]),
			doc: this.parseObj({"title":{"ind":24,"str":"Subdivisions"},"chapter":{"ind":0,"str":"General Provisions"},"section":{"ind":0,"str":"Short Title"},"properties":{"published":false,"title":"","label":"","place":"Edit Place","description":"...edit description... OKsimple programmer","media":[{"_id":"5b5577c78d0791e8b28767d6","index":0,"name":"Sample image","image":"/publishers/ordinancer/images/full/0/img_0.png","thumb":"/publishers/ordinancer/images/thumbs/0/thumb_0.png","caption":"Sample caption","postscript":"img.postscript"}]},"geometry":{"coordinates":[-111.854704,40.769673],"type":"Point"},"_id":"5b5247a03ae467d9b385ea10","type":"Feature","index":0,"__v":0}),
			edit: null,
			dindexes: [],
			dindex: (this.parseObj({"title":{"ind":24,"str":"Subdivisions"},"chapter":{"ind":0,"str":"General Provisions"},"section":{"ind":0,"str":"Short Title"},"properties":{"published":false,"title":"","label":"","place":"Edit Place","description":"...edit description... OKsimple programmer","media":[{"_id":"5b5577c78d0791e8b28767d6","index":0,"name":"Sample image","image":"/publishers/ordinancer/images/full/0/img_0.png","thumb":"/publishers/ordinancer/images/thumbs/0/thumb_0.png","caption":"Sample caption","postscript":"img.postscript"}]},"geometry":{"coordinates":[-111.854704,40.769673],"type":"Point"},"_id":"5b5247a03ae467d9b385ea10","type":"Feature","index":0,"__v":0}) === '' ? 0 : this.parseObj({"title":{"ind":24,"str":"Subdivisions"},"chapter":{"ind":0,"str":"General Provisions"},"section":{"ind":0,"str":"Short Title"},"properties":{"published":false,"title":"","label":"","place":"Edit Place","description":"...edit description... OKsimple programmer","media":[{"_id":"5b5577c78d0791e8b28767d6","index":0,"name":"Sample image","image":"/publishers/ordinancer/images/full/0/img_0.png","thumb":"/publishers/ordinancer/images/thumbs/0/thumb_0.png","caption":"Sample caption","postscript":"img.postscript"}]},"geometry":{"coordinates":[-111.854704,40.769673],"type":"Point"},"_id":"5b5247a03ae467d9b385ea10","type":"Feature","index":0,"__v":0}).index),
			cursor: null,
			input: '',
			fixedPug: ''/*,
			diff: {
				old: this.parseObj(),
				new: null
			}*/
		}
	},
	mounted: function(){
		var self = this;
		if (self.doc === '') {
			self.doc = data[0]
		}
		self.dindexes = self.data.map(function(doc){
			return doc.index;
		})
		if ( document.getElementById("layouttext")) {
			var simplemde = new SimpleMDE({
				element: document.getElementById("layouttext")
			});
		}
		//self.diff.old = $('#diff').html().toString()
		//console.log(document.getElementById('diff'))
		//.innerHTML.toString())
		//console.log(pug.render(self.$el.innerHTML.toString())
		/*var str = this.$el.innerHTML.toString();
		var len = str.length;
		if (!self.cursor) {
			self.cursor = len - 1;
		}
		self.input = str;
		self.checkPug()
		*/
	},
	beforeDestroy: function(){
		
	},
	methods: {
		submitForm: function(ind){
			$('#form_'+ind+'').submit()
		},
		/*checkPug: function() {
			var self = this;
			var str = self.input;
			var len = str.length;
			
			var parts = [];
			// from Pug Lexer
			var captures, captured;
			console.log(str)
			if (captures = /^(\w[-:\w]*)(\/?)/.exec(str)) {
				console.log(captures)
				//self.consume(captures[0].length);
				//self.cursor += captures[0].length;
				self.cursor = len;
				self.input = str.substr(len)
				var name = captures[1];
				var tok;
				if (':' === name[name.length-1]){
					name = name.slice(0,-1);
					tok = name;
					//parts.push(name)
					//self.tok = name;
					while (' ' === self.input[0]) self.cursor--;//self.input = self.input.substr(1);
				} else {
					//parts.push(name)
					//self.tok = name
					tok = name
				}
				if (!captures[2]) {//return false;
					captured = captures[1].splice(captures[1].split('').indexOf('>'), '/');
					captures[1] = captured.join('')
				}//tok.selfClosing = 
			}
		},*/
		parseObj: function(obj) {
			if (!obj) return '';
			return obj;
		},
		toggleEdit: function(ind) {
			this.edit = (!this.edit ? ind : null);
		},
		addNewMedia: function(id, index) {

			$.post('/api/newmedia/'+id+'/'+index+'', function(res) {
				console.log(res)
				$('#appendmedia').append(res);
				//window.location.reload(true)
			})
		},
		handleFile: function(dindex, index) {
			var self = this;
			self.dindex = dindex;
			self.file = document.getElementById('media_'+index).files[0];
			self.processImage(index);
		},
		processImage: function(imgindex) {
			var self = this;
			var dataurl = null;
			var file = self.file;
			console.log(file)
			if (!file) return;
			var imagefile = file.type;
			var imageTypes= ["image/jpeg","image/png","image/jpg","image/svg+xml"];
			if(imageTypes.indexOf(imagefile) === -1) {
				$("#info").html("<span class='msg-error'>Please Select A valid Image File</span><br /><span>Only jpeg, jpg, png, and pdf types allowed</span>");
				return false;
				
			} else {
				var reader = new FileReader();
				
				reader.onloadend = function(e) {
					var img = document.getElementById('return'+imgindex+'');
					img.src = e.target.result;

					img.onload = function() {
						$('#media').val('');
						var can = $('#canvas'+imgindex+'')[0];
						var maxWidth = 1700 ;
						var maxHeight = 1700 ;
						var w = img.width;
						var h = img.height;
						can.width = w;
						can.height = h;
						var ctx = can.getContext("2d");
						ctx.drawImage(img, 0, 0);
						self.checkImage(img, can, w, h, maxWidth, maxHeight, imgindex, imagefile.split('image/')[1]);
					}
					
				}
				reader.readAsDataURL(file);
			}
		},
		checkImage: function(img, can, w, h, maxWidth, maxHeight, imgindex, imgtype) {
			if (h > maxHeight) {
				this.reSize(img, can, w, h, maxWidth, maxHeight, imgindex, imgtype)
			} else {
				if (maxHeight === 400) {
					this.drawThumb(img, can, w, h, imgindex, imgtype)
				} else {
					this.drawFull(img, can, w, h, imgindex, imgtype)
				}
			}
			
		},
		reSize: function(img, can, w, h, maxWidth, maxHeight, imgindex, imgtype){
			can.height = h*0.75;
			can.width = w*0.75;

			var can2 = document.createElement('canvas');
			can2.width = w*0.75;
			can2.height = h*0.75;
			var ctx2 = can2.getContext('2d');
			var ctx = can.getContext('2d');
			ctx2.drawImage(img, 0, 0, w*0.75, h*0.75);
			ctx.drawImage(can2, 0, 0, w*0.75, h*0.75, 0, 0, w*0.75, h*0.75);
			w = w*0.75;
			h = h*0.75;
			img.width = w;
			img.height = h;
			this.checkImage(img, can, w, h, maxWidth, maxHeight, imgindex, imgtype)
		},
		drawFull: function(img, can, w, h, imgindex, imgtype) {
			var self = this;
			can.height = h;
			can.width = w;
			var ctx = can.getContext('2d');
			
			ctx.drawImage(img, 0, 0, w, h);
			if (!HTMLCanvasElement.prototype.toBlob) {
			 Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
				value: function (callback, type, quality) {
					var binStr = atob( this.toDataURL(type, quality).split(',')[1] ),
					len = binStr.length,
					arr = new Uint8Array(len);
					for (var i = 0; i < len; i++ ) {
						arr[i] = binStr.charCodeAt(i);
					}
					callback( new Blob( [arr], {type: type || 'image/png'} ) );
				}
			 });
			}
			can.toBlob(function(blob) {
				var fd = new FormData();

				fd.append("img", blob);
				
				var uploadurl = '/api/uploadmedia/'+self.dindex+'/'+imgindex+'/png';
				console.log(uploadurl)
				$.ajax({
					url: uploadurl,
					type: 'POST',
					data: fd,
					processData: false,
					contentType: false,
						success: function(response) { 
						img.src = response.replace('/var/www/pu', '').replace('/Users/traceybushman/Documents/pu.bli.sh/pu', '');
						img.onload = function () {
							console.log(img, response)
							$('#inputimg'+imgindex+'').val(response.replace('/var/www/pu', '').replace('/Users/traceybushman/Documents/pu.bli.sh/pu', ''))
							var can = $('#canvas'+imgindex+'')[0];
							$('.return'+imgindex+'').attr('src', response.replace('/var/www/pu', '').replace('/Users/traceybushman/Documents/pu.bli.sh/pu', ''));
							var maxWidth = 400 ;
							var maxHeight = 400 ;
							var w = img.width;
							var h = img.height;
							self.checkImage(img, can, w, h, maxWidth, maxHeight, imgindex, imgtype);
						}
					}
				})
			}, 'image/png');
		},
		drawThumb: function(img, can, w, h, imgindex, imgtype) {
			var self = this;
			can.height = h;
			can.width = w;
			var ctx = can.getContext('2d');
			
			ctx.drawImage(img, 0, 0, w, h);
			dataurl = can.toDataURL("image/png", 0.8);
			//console.log(dataurl)
			setTimeout(function(){
				$('#inputthumb'+imgindex+'').val(dataurl.replace(/data:image\/png;base64,/, ''));
				//countUp(parseInt(counter, 10))
				self.data[dindex].properties.media[imgindex].thumb = dataurl;
				self.doc.properties.media[imgindex].thumb = dataurl;
			}, 100);
		}
	}
});</script></body></html>